{% load static %}
{% load auth_extras %}

{% if user.is_authenticated %}
<div class="modal fade" id="profile-modal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow border-0">
            
            <div class="modal-header pb-0">
                <div class="d-flex flex-wrap align-items-center gap-3 w-100 mb-3">
                    <div class="position-relative">
                        <img id="header-avatar"
                        src="{{ user.profile_picture.url }}" 
                        alt="{{ user.username }}" 
                        class="rounded-circle border" 
                        style="width: 64px; height: 64px; object-fit: cover;">
                        {% if user|is_online %}
                        <span class="position-absolute bottom-0 status-online border border-3 border-white rounded-circle" style="right: 6px; padding: 6px;"></span>
                        {% endif %}
                    </div>
                    
                    <div class="flex-grow-1" style="min-width: 150px;">
                        <h5 class="mb-1 fw-bold text-dark">{{ user.get_full_name|default:user.username }}</h5>
                        <p class="text-muted mb-0 small">{{ user.email|default:"email@naoinformado.com" }}</p>
                    </div>
                    
                    <div class="ms-auto">
                        <ul class="nav" id="profileTab" role="tablist">
                            <li class="nav-item px-1" role="presentation">
                                <button class="btn btn-sm btn-outline-light border text-dark active" 
                                        id="profile-info-tab" 
                                        data-bs-toggle="tab" 
                                        data-bs-target="#profile-info" 
                                        type="button" 
                                        role="tab">
                                    Perfil
                                </button>
                            </li>
                            <li class="nav-item px-1" role="presentation">
                                <button class="btn btn-sm btn-outline-light border text-dark" 
                                        id="change-password-tab" 
                                        data-bs-toggle="tab" 
                                        data-bs-target="#change-password" 
                                        type="button" 
                                        role="tab">
                                    Alterar Senha
                                </button>
                            </li>
                            <li class="nav-item px-1">
                                <a href="{% url 'base:self_profile_update' %}" class="btn btn-sm btn-outline-light border text-dark">
                                    <i class="bi bi-gear"></i>
                                </a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>

            <div class="tab-content" id="profile-tabs-content">
                
                <div class="tab-pane fade show active" id="profile-info" role="tabpanel" tabindex="0">
                    <form method="POST" enctype="multipart/form-data" action="{% url 'base:self_profile_update' %}">
                        {% csrf_token %}
                        
                        <div class="modal-body">        
                            <div class="d-flex flex-column gap-3">
                                
                                <div class="alert alert-light border bg-light text-muted small d-flex align-items-center mb-2 p-2">
                                    <i class="bi bi-person-vcard me-2 fs-5"></i>
                                    <div style="line-height: 1.2;">
                                        <span class="fw-bold d-block">Dados Pessoais</span>
                                        <span style="font-size: 0.75rem;">Mantenha as suas informações de contato atualizadas.</span>
                                    </div>
                                </div>

                                <div class="row align-items-center g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small">Nome</label>
                                    <div class="col-sm-9">
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-white border-end-0 text-muted">
                                                        <i class="bi bi-person"></i>
                                                    </span>
                                                    <input type="text" name="first_name" 
                                                        class="form-control border-start-0 ps-0 text-dark" 
                                                        value="{{ user.first_name }}" placeholder="Nome">
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-white border-end-0 text-muted">
                                                        <i class="bi bi-tag"></i> </span>
                                                    <input type="text" name="last_name" 
                                                        class="form-control border-start-0 ps-0 text-dark" 
                                                        value="{{ user.last_name }}" placeholder="Sobrenome">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row align-items-center g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small">Email</label>
                                    <div class="col-sm-9">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0 text-muted">
                                                <i class="bi bi-envelope"></i>
                                            </span>
                                            <input type="email" name="email" 
                                                class="form-control border-start-0 ps-0 text-dark" 
                                                value="{{ user.email }}" placeholder="exemplo@email.com">
                                        </div>
                                    </div>
                                </div>

                                <div class="row align-items-center g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small">IP Acesso</label>
                                    <div class="col-sm-9">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light border-end-0 text-muted">
                                                <i class="bi bi-hdd-network"></i>
                                            </span>
                                            <input type="text" disabled 
                                                class="form-control bg-light border-start-0 ps-0 text-muted" 
                                                value="{{ user.allowed_ip_address|default:'Sem restrição' }}">
                                        </div>
                                    </div>
                                </div>
                                
                                {% for field in user_change_form %}
                                    {% if field.name != 'profile_picture' %}
                                        {% for error in field.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}

                                <hr class="text-muted opacity-25 mb-3">

                                <div class="row align-items-start g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small pt-3">
                                        Foto
                                    </label>
                                    <div class="col-sm-9">
                                        <div class="d-flex align-items-center p-2 border rounded bg-light">
                                            <img id="input-avatar" 
                                                    src="{{ user.profile_picture.url }}" 
                                                    class="rounded-circle border bg-white" 
                                                    width="50" height="50" 
                                                    style="object-fit: cover;">

                                            <div class="ms-3 flex-grow-1">
                                                <label for="avatar-upload" class="btn btn-sm btn-white border text-dark fw-semibold shadow-sm position-relative cursor-pointer">
                                                    <i class="bi bi-upload me-1"></i> Carregar nova imagem
                                                    <input type="file" name="profile_picture" id="avatar-upload" 
                                                        class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                                                        style="cursor: pointer;">
                                                </label>
                                                <div class="form-text mt-1 small" style="font-size: 0.7rem;">
                                                    Recomendado: JPG ou PNG quadrado.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% for error in user_change_form.profile_picture.errors %}
                                            <div class="text-danger mt-2 small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="modal-footer border-top p-3 bg-light rounded-bottom text-end">
                            <button type="button" class="btn btn-white border text-dark bg-white fw-semibold btn-sm px-3" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" name="btn_profile_update" class="btn btn-dark fw-semibold btn-sm px-3">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
          
                <div class="tab-pane fade" id="change-password" role="tabpanel" tabindex="0">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="password_change">
                        
                        <div class="modal-body">
                            <div class="d-flex flex-column gap-3"> 
                                
                                <div class="alert alert-light border bg-light text-muted small d-flex align-items-center mb-2 p-2">
                                    <i class="bi bi-shield-lock me-2 fs-5"></i>
                                    <div style="line-height: 1.2;">
                                        <span class="fw-bold d-block">Segurança da Senha</span>
                                        <span style="font-size: 0.75rem;">Use 8+ caracteres, misture letras e números.</span>
                                    </div>
                                </div>

                                {% if password_change_form.non_field_errors %}
                                    <div class="alert alert-danger py-2 small">
                                        {{ password_change_form.non_field_errors }}
                                    </div>
                                {% endif %}

                                <div class="row align-items-center g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small">Senha Atual</label>
                                    <div class="col-sm-9">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0 text-muted">
                                                <i class="bi bi-key"></i>
                                            </span>
                                            <input type="password" name="old_password" id="id_old_password" 
                                                class="form-control border-start-0 border-end-0 ps-0 text-dark" 
                                                placeholder="Digite sua senha atual" required>
                                            <button class="btn btn-outline-light border border-start-0 text-muted toggle-password" 
                                                    type="button" data-target="id_old_password">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        {% for error in password_change_form.old_password.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="row align-items-center g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small">Nova Senha</label>
                                    <div class="col-sm-9">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0 text-muted">
                                                <i class="bi bi-lock"></i>
                                            </span>
                                            <input type="password" name="new_password1" id="id_new_password1" 
                                                class="form-control border-start-0 border-end-0 ps-0 text-dark" 
                                                placeholder="Nova senha" required>
                                            <button class="btn btn-outline-light border border-start-0 text-muted toggle-password" 
                                                    type="button" data-target="id_new_password1">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        
                                        {% if password_change_form.new_password1.help_text %}
                                            <div class="form-text text-muted small mt-1" style="font-size: 0.7rem;">
                                                {{ password_change_form.new_password1.help_text }}
                                            </div>
                                        {% endif %}

                                        {% for error in password_change_form.new_password1.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="row align-items-center g-2">
                                    <label class="col-sm-3 col-form-label fw-semibold text-secondary small">Confirmar</label>
                                    <div class="col-sm-9">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-white border-end-0 text-muted">
                                                <i class="bi bi-check-circle"></i>
                                            </span>
                                            <input type="password" name="new_password2" id="id_new_password2" 
                                                class="form-control border-start-0 border-end-0 ps-0 text-dark" 
                                                placeholder="Repita a nova senha" required>
                                            <button class="btn btn-outline-light border border-start-0 text-muted toggle-password" 
                                                    type="button" data-target="id_new_password2">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        {% for error in password_change_form.new_password2.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="modal-footer border-top p-3 bg-light rounded-bottom text-end">
                            <button type="button" class="btn btn-white border text-dark bg-white fw-semibold btn-sm px-3" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" name="btn_password_update" class="btn btn-dark fw-semibold btn-sm px-3">Atualizar Senha</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // 1. Script para preview da imagem
    const avatarInput = document.getElementById('avatar-upload');
    if (avatarInput) {
        avatarInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const inputAvatar = document.getElementById('input-avatar');
                    if (inputAvatar) inputAvatar.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    }

    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            const icon = this.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });
</script>

{% endif %}